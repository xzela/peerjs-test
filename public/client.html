<!doctype html>
<html>
	<head>
	</head>
	<body>
		<h3>Peers</h3>
		<ul id="peers">
		</ul>

		<h3>You [<span class="peerId"></span>]</h3>
		<h3>Sent:</h3>
		<pre class="local">
		</pre>

		<h3>Remote Messages:</h3>
		<pre class="remote">
		</pre>
		<h3> Remote Connection Data:</h3>
		<pre class="remote-connect-data">
		</pre>

		<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
		<script src="http://cdn.peerjs.com/0.3/peer.js"></script>
		<script>
			var servers = [
				{url:'stun:stun01.sipphone.com'},
				{url:'stun:stun.ekiga.net'},
				{url:'stun:stun.fwdnet.net'},
				{url:'stun:stun.ideasip.com'},
				{url:'stun:stun.iptel.org'},
				{url:'stun:stun.rixtelecom.se'},
				{url:'stun:stun.schlund.de'},
				{url:'stun:stun.l.google.com:19302'},
				{url:'stun:stun1.l.google.com:19302'},
				{url:'stun:stun2.l.google.com:19302'},
				{url:'stun:stun3.l.google.com:19302'},
				{url:'stun:stun4.l.google.com:19302'},
				{url:'stun:stunserver.org'},
				{url:'stun:stun.softjoys.com'},
				{url:'stun:stun.voiparound.com'},
				{url:'stun:stun.voipbuster.com'},
				{url:'stun:stun.voipstunt.com'},
				{url:'stun:stun.voxgratia.org'},
				{url:'stun:stun.xten.com'},
				{
					url: 'turn:numb.viagenie.ca',
					credential: 'muazkh',
					username: 'webrtc@live.com'
				},
				{
					url: 'turn:192.158.29.39:3478?transport=udp',
					credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
					username: '28224511:1379330808'
				},
				{
					url: 'turn:192.158.29.39:3478?transport=tcp',
					credential: 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
					username: '28224511:1379330808'
				}
			];
			function fetchPeers(id) {
				$('#peers').empty();
				$.getJSON('/peers?id=' + id, function (data) {
					$.each(data, function (key, value) {
						if (id !== value) {
							$('#peers').append($('<li class="peer">').text(value));
						}
					});
				});
			}
			$(document).ready(function () {

				var config = {
					key: 'fun',
					// host: 'express.ngrok.com',
					host: 'localhost',
					port: 3001,
					secure: true,
					path: 'foo',
					config: {
						'iceServers': servers
					},
					debug: 1
				}
				var id = new Date().getTime().toString(32);
				$('.peerId').text(id);
				var peer = new Peer(id , config);

				peer.on('open', function (id) {
					fetchPeers(id);
					console.log('[local-peer]', 'peer id', id);
					setInterval(function () {fetchPeers(id)}, 10000);
				});

				peer.on('data', function (data) {
					console.log('[local-peer]', 'data:', data);
				});

				peer.on('connection', function (conn) {
					console.log(conn);
					conn.on('data', function (data) {
						$('.remote').text('peer: ' + conn.peer + ', just sent: ' + data);
						console.log('[local-peer]', 'remote peer sent:', data);
					});
				});

				$('ul').on('click', 'li', function (evnt) {
					var p2Id = $(this).text();
					var conn = peer.connect(p2Id);
					conn.on('open', function () {
						var string = 'word up';
						$('.local').text('You just sent: ' + string);
						conn.send(string);

						console.log('[local-peer]', 'open connection to remote peer:', p2Id);
						conn.on('error', function (err) {
							console.log(err);
						});

						$('.remote-connect-data').text(JSON.stringify(conn.peerConnection, null, '\t'));

					});
					// console.log(conn.peerConnection);
				});


			});
		</script>
	</body>
</html>
